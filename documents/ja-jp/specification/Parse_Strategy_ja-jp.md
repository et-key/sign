# Sign言語パーサー設計仕様

## 基本原理

**Sign言語記法変換器**：多様なSign記法を統一されたSign記法に正規化する。

## 段階的再帰処理アルゴリズム

### 処理フロー
```
1. トークナイズ（保護）
2. 記法変換  
3. 1段階内側を展開
4. 繰り返し（変化がなくなるまで）
```

### トークン保護ルール
- **カッコ内**: `[+ 1]` → `__BRACKET_+ 1__`
- **ブロック内**: インデント部分 → `__BLOCK_内容__`
- **文字列**: `"hello"` → `__STRING_hello__`
- **文字**: `\ ` → `__CHAR_SPACE__`

### 変換例
```
入力: f : x ? [+ 1] (x * 2)

段階1: f : x ? __BRACKET__ __PAREN__
      → ([:] f ([?] x __BRACKET__ __PAREN__))
      
段階2: ([:] f ([?] x ([+] 1) __PAREN__))
      → ([:] f ([?] x ([+] 1) __PAREN__))
      
段階3: ([:] f ([?] x ([+] 1) ([*] x 2)))
      → 完了（変化なし）
```

## ブロック構造の統一処理

**インデントブロック = ネストしたリスト構造**

### インデント→カッコ変換
```
x :
    v : 3
    f : x y ?
        x = 0 : x
        x = 1 : y

↓

x : [[v : 3] [f : x y ? [[x = 0 : x] [x = 1 : y]]]]
```

### 特性
- 同じインデントレベル = 同じリスト内の要素
- 深いインデント = ネストしたリスト構造  
- インラインカッコと完全に等価な処理
- 段階的処理で自然に展開

**段階的処理によりカッコが優先順位境界を自動形成**

### 例：優先順位の自然な処理
```
(2 + 3) * 4

段階1: __PAREN__ * 4 → ([*] __PAREN__ 4)
段階2: ([*] ([+] 2 3) 4)
```

### 特性
- カッコ内は後の段階で独立処理
- カッコ外の演算子が先に処理される
- 優先順位判定ロジック不要
- 自然な数学記法との一致

## 結合性の革命的解決

**中置記法の制約から多項演算への転換**

### 統一的な多項式表現
```
5 + 4 + 3 + 2  →  ([+] 5 4 3 2)  // 左結合演算子
5 ^ 4 ^ 3 ^ 2  →  ([^] 5 4 3 2)  // 右結合演算子
```

### 遅延評価による結合順序解決
- **構文解析時**: すべて同一の多項式形式
- **評価時**: 遅延評価が適切な結合順序を自動選択
- **結果**: 構文解析器に結合性判定ロジック不要

### 特性
- 全演算子が完全に統一的な処理
- 左結合・右結合の区別が構文レベルで消滅
- 遅延評価システムに評価順序を委譲

**高優先順位から低優先順位の順で処理**

### 処理順序
```
優先順位16: * / % (最高)
優先順位15: + -
...
優先順位1: # (最低)
```

### 例：自然な優先順位処理
```
a + b * c - d

段階1(優先順位16): a + ([*] b c) - d  
段階2(優先順位15): ([+] a ([*] b c)) - d → ([-] ([+] a ([*] b c)) d)
```

### 特性
- 数学的優先順位と完全一致
- 高優先順位が先に「保護」される
- 段階的に低優先順位が包み込む構造

**ポイントフリー記法によるラムダ化で統一処理**

### 変換規則
- **中置演算子**: `1 + 2` → `([+] 1 2)`
- **前置演算子**: `!x` → `([!_] x)`
- **後置演算子**: `10!` → `([_!] 10)`
- **定義**: `f : expr` → `([:] f expr)`
- **ラムダ**: `x ? body` → `([?] x body)`
- **絶対値囲み**: `|x + y|` → `([|_|] ([+] x y))`

### 位置判定ルール
- 記号が先頭 → 前置演算子
- 記号が末尾 → 後置演算子  
- 記号が中間 → 中置演算子
- 記号で囲み → 特殊囲み記法（絶対値等）

### 特性
- `_`（Unit）の位置で演算子の位置情報を表現
- 全演算子が統一的な関数適用形式
- カッコの種類は無関係（()、[]、{}は同一）

## 設計特性

- **外側から内側への自然な深化**
- **意味を一切変更しない等価変換**
- **保護機構により誤変換を防止**
- **自動収束による処理完了**
- **位置依存判定不要の統一演算子処理**