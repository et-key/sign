# Sign WASM版 フェーズ4〜7 実装計画 (コア評価モデル修復と完全な仕様準拠)

本計画では、フェーズ3.5までに構築されたWASM基盤の上に、Sign言語の根幹機能（カリー化、関数合成）を修復し、暫定実装に留まっている辞書操作・束縛機能を完全化し、すべての演算子が仕様書（`A_Operator_Table.md`）通りに動作するWASMコンパイラを完成させるためのステップを定義します。

## フェーズ4: 関数適用のコア評価モデルの完全化
Sign言語の根幹である「カリー化（部分適用）」と「ポイントフリー記法（関数合成）」の挙動が正しく機能していない現状の課題を最優先で修正します。

### 1. ポイントフリー記法（関数合成）の修復
- **現状の課題**: `1 # [+ 2] [* 5] 4` が期待値 `30` ではなく `20` を返すなど、データフローが途切れている。
- **実装内容**: `expandMacros`（ASTの展開）またはパイプライン処理を見直し、連続するブロック/配列が正しく「関数合成」として直列に評価されるように修正します。

### 2. 引数不足時の部分適用（カリー化・クロージャ返却）の徹底
- **現状の課題**: 引数不足の関数が評価された際、計算を強行させず `NaN` を返しているが、本来は未評価のクロージャを返すのが仕様。
- **実装内容**: `compiler_wat.js` を修正し、引数不足時は計算命令を出力せず、キャプチャした引数を伴う「クロージャポインタ」をWASMのスタックに積むようにします。
- **付随対応**: Ph3.5残件である「ブロック直後の値の解釈ズレ（例: `[ * ] 10`）」を解消し、パイプラインが正しく結合されるようにパーサを修正します。

---

## フェーズ5: 辞書と束縛の動的解決（暫定実装の解消）
現在、特定の条件下でしか動作しない `compiler_wat.js` の妥協的実装を解消し、言語としての表現力を完全なものにします。

### 1. 中置 `:` (define / 束縛) の汎用化
- **現状の課題**: ブロック直下での変数定義としてのみ機能しており、式の途中で単独の `:` が現れると `NaN` にフォールバックする。
- **実装内容**: 任意のスコープ・式中で動的に環境（Environment）を生成・更新し、値を束縛する処理をWASM命令として実装します。

### 2. 中置 `'` (get / 所有格アクセス) の動的キー解決
- **現状の課題**: コンパイル時に静的オフセットが確定できるプロパティアクセスしかできず、動的なキーアクセスが `NaN` になる。
- **実装内容**: 実行時にWASMメモリ上の辞書（環境）から、文字列や変数をキーとして動的に値を検索・取得するロジック（ハッシュ解決または線形探索）を実装します。

---

## フェーズ6: 境界演算子とExport/Import群の実装
Signの「ハイブリッドマシン」を橋渡しする演算子と、モジュール・環境インターフェースを実装します。パーサの優先順位修正も併せて行います。

### 1. 演算子優先順位の正常化 (仕様書準拠)
- **現状の課題**: `operators.js` で前置 `#`, `!`, `$`, `@` や後置 `@` 等が `Infinity` にハードコードされている。
- **実装内容**: 仕様書（`A_Operator_Table.md`）の優先順位に従い `Infinity` を廃止し、正しいASTが構築されるように修正します。

### 2. ハイブリッドマシン境界演算子 (`$`, `@`, `#`) のWASM化
- **`$` (前置: Address)**: 評価対象のメモリアドレス（ポインタ）を取得する処理。
- **`@` (中置/前置: At/Input)**: アドレスからデータを引き出す処理。
- **`#` (中置: Output)**: 現状のコンソール出力（デバッグプリント）としての暫定実装を、仕様書が意図する「アドレスへのデータ関連付け」へと設計を見直します。

### 3. Export / Import 演算子の実装
- **前置 `#`, `##`, `###` (Export群)**: WASMモジュールからの関数/メモリのエクスポートや公開領域へのマッピング処理を追加。
- **後置 `@` (Import)**: ファイルや外部リソースからの取得。WASM/JS境界での非同期・同期ロードの仕組みを設計し実装します。

---

## フェーズ7: リスト操作・その他未実装ノードのWASM化
仕様書に存在するものの、AST処理が欠落している基本演算子群に対応します。

### 1. 欠落しているASTノードのコンパイル実装
- **絶対値 `|...|`**: WASMの `f64.abs` を割り当て。
- **後置演算子 `!` (階乗)**: 階乗のループ/再帰ロジックのWASM生成。
- **文字リテラル (`\c`)**: 文字コード（f64）としての評価処理。

### 2. 余積（空白）によるリスト操作と連続・スプレッド展開
- **リスト操作 (`push`, `concat`, `construct`)**: 優先順位8の余積演算子によるリストのメモリ上での繋ぎ変え・構築処理を実装します。
- **前置 `~` (Continuous)**: 連続リスト構築のWASM処理。
- **後置 `~` (Expand)**: スタブになっている `$spread_concat` などの関数中身を実装し、リスト展開を実現します。
- **Range演算子 (`~+`, `~-` 等)**: 範囲リストをメモリ上に動的に構築するループ命令を実装します。