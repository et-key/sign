# 実装計画: WASM フェーズ 5 (配列・文字列の展開とストリームI/O)

## 目標
Sign言語の最もエレガントな機能の一つである「後置 `~`（展開演算子）」をWASMコンパイラに実装します。これにより、メモリ上に不透明なオブジェクト（NaN-boxingされたポインタ）として存在するリストや文字列を、安全かつ直感的にスタックや出力ストリームへ展開（Unroll）できるようにします。

## 現状の課題
- リストや文字列を `1 #` で出力しようとすると、仕様通り `NaN` が返る。
- 中身を1つずつ出力したり、他の関数へ連続して適用したりするための手段（スプレッド展開）がWASM上で未実装である。

## 実装する仕様と変更点

### 1. 後置 `~` (Expand / 展開演算子) のWASMネイティブループ実装
`compiler_wat.js` の `compileNode` 内に、後置 `~` の処理を組み込みます。

- **リスト展開 (`list~`)**:
  1. `~` の左辺（ポインタ）を評価し、NaNタグを剥がす。
  2. メモリから `car`（値）と `cdr`（次のポインタ）をロードする。
  3. WASMの `loop` と `br_if` を用いて、`cdr` が `NaN`（リストの終端）になるまで、`car` の値を次々とスタックに積む（あるいは後続の式へストリームする）WASM命令を生成する。
- **文字列展開 (`"abc"~`)**:
  1. 同様に文字列ポインタのNaNタグを剥がす。
  2. 文字列は `i32.load8_u` で1バイトずつ読み取る。
  3. `\0` (null終端) に到達するまで、文字のASCIIコード（f64）をスタックに展開するループ命令を生成する。

### 2. ストリームI/Oとの連携
展開された値が `1 #` などの出力演算子に渡された際、スタック上の値が順番に出力ポートにストリームされるデータフローを構築します。
これにより、`1 # "Hello"~` というコードが `H`, `e`, `l`, `l`, `o` を順番にコンソールへ出力するようになります。

## 検証計画
- `test_all.sn` のPh2において、`1 # "Hello! WASM Strings!"~` が各文字を出力するか確認する。
- リスト `list : 100, 200` に対して `1 # list~` が `100` と `200` を連続して出力するか確認する。