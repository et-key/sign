<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<title>Sign WASM Playground</title>
	<script src="https://unpkg.com/wabt@1.0.32/index.js"></script>
	<style>
		body {
			font-family: monospace;
			display: flex;
			flex-direction: column;
			padding: 20px;
			background: #fafafa;
		}

		.top-panels {
			display: flex;
			gap: 20px;
			margin-bottom: 10px;
		}

		.input-panel {
			flex: 1;
			display: flex;
			flex-direction: column;
		}

		textarea {
			height: 100px;
			font-family: monospace;
			font-size: 16px;
			padding: 10px;
			border-radius: 5px;
			border: 1px solid #ccc;
		}

		.panels {
			display: flex;
			gap: 20px;
			margin-top: 10px;
		}

		.panel {
			flex: 1;
			display: flex;
			flex-direction: column;
			min-width: 0;
		}

		pre {
			background: #1e1e1e;
			color: #d4d4d4;
			padding: 15px;
			overflow-x: auto;
			flex-grow: 1;
			border-radius: 5px;
			font-size: 14px;
		}

		button {
			padding: 10px 20px;
			font-size: 16px;
			font-weight: bold;
			cursor: pointer;
			background: #007acc;
			color: white;
			border: none;
			border-radius: 5px;
			align-self: flex-start;
		}

		button:hover {
			background: #005999;
		}
	</style>
</head>

<body>

	<h2>Sign → WebAssembly Playground (f64)</h2>

	<div class="top-panels">
		<div class="input-panel">
			<label><strong>Sign Code:</strong></label>
			<textarea id="codeInput"></textarea>
		</div>
		<div class="input-panel">
			<label><strong>Standard Input:</strong></label>
			<textarea id="stdInput"></textarea>
		</div>
	</div>

	<button id="runBtn">Compile & Run WASM</button>

	<div class="panels">
		<div class="panel">
			<h3>Generated WAT</h3>
			<pre id="watOutput"></pre>
		</div>
		<div class="panel">
			<h3>Execution Output</h3>
			<pre id="consoleOutput"></pre>
		</div>
	</div>

	<script type="module">
		import { parseSign } from './parser_browser.js';
		import { compileToWat } from './compiler_wat.js';

		document.getElementById('runBtn').addEventListener('click', async () => {
			const code = document.getElementById('codeInput').value;
			const stdinText = document.getElementById('stdInput').value;
			const outputEl = document.getElementById('consoleOutput');
			outputEl.textContent = '';

			try {
				// 1. 標準入力をパースして配列（キュー）にする
				const inputQueue = stdinText.split(/\s+/)
					.filter(x => x !== '')
					.map(x => parseFloat(x) || 0.0);
				let inputPointer = 0;

				// 2. Signコードの構文解析
				const ast = parseSign(code);

				// 3. WATの生成
				const watCode = compileToWat(ast);
				document.getElementById('watOutput').textContent = watCode;

				// 4. WABTによるバイナリコンパイル
				const wabt = await WabtModule();
				const module = wabt.parseWat('test.wat', watCode);
				module.resolveNames();
				module.validate();
				const { buffer } = module.toBinary({ log: true });

				// 5. WASMインポート環境
				let wasmMemory;
				const importObject = {
					env: {
						print_string: (ptr, len) => {
							if (wasmMemory) {
								const bytes = new Uint8Array(wasmMemory.buffer, ptr, len);
								const str = new TextDecoder('utf-8').decode(bytes);
								outputEl.textContent += `[Print] ${str}\n`;
							}
						},
						print_float: (arg) => {
							outputEl.textContent += `[Print] ${arg}\n`;
						},
						input_float: () => {
							if (inputPointer < inputQueue.length) {
								return inputQueue[inputPointer++];
							}
							return 0.0; // 入力が尽きた場合は 0.0 を返す
						},
						math_fmod: (a, b) => a % b,
						math_pow: Math.pow
					}
				};

				// 6. 実行
				const wasmInstance = await WebAssembly.instantiate(buffer, importObject);
				wasmMemory = wasmInstance.instance.exports.memory;
				const result = wasmInstance.instance.exports.main();

				outputEl.textContent += `\n[Main Result] ${result}\n`;

			} catch (err) {
				outputEl.textContent = `Error: ${err.message}`;
				console.error(err);
			}
		});
	</script>
</body>

</html>