# Sign言語パーサー実装の変遷と修正内容まとめ (proto/a2)

本ドキュメントは、Sign言語パーサー（`proto/a2`）の実装において、`proto/a1` からの進化および修正内容をまとめたものです。

## 1. 絶対値表記 (`|...|`) のサポート

### 1-1. 課題と解決策
*   **課題**: パイプ記号 `|` は絶対値（囲み）とビット演算 OR（中置）の両方で使われるため、単純なトークン分割では衝突する。
*   **対応**:
    *   **厳格な空白ルール**:
        *   `a | b` (両側に空白あり) → 中置演算子（OR）
        *   `|x` (直後に空白なし) → 絶対値開始 (`[|`)
        *   `x|` (直前に空白なし) → 絶対値終了 (`|]`)
        *   `a|b` (両側空白なし) → 構文エラー
    *   **内部処理**:
        *   Tokenizerで空白のコンテキストを保持し、Pass 1で `|` を `[|` (Open) または `|]` (Close)、あるいは通常の `|` (Infix) に置換。
        *   Shunting Yardアルゴリズム内で `[| ... |]` を括弧と同様に処理し、リスト構築ではなく **算術式の一部** としてパース。

### 1-2. 出力シンボルの変更
*   **初期案**: `["|", expr]`
*   **採用案**: `["!-", expr]`
*   **理由**:
    *   ビット演算（`|`）やリスト構築との混同を防ぐため。
    *   `!-` (Not Minus) という記号により、「負ではない＝絶対値」という意味を明確化。
    *   S式としての可読性が向上。

---

## 2. 実装アーキテクチャの変更

*   **prepare_lexer.js の分離**: `|` 記号をトークンとして認識させるため区切り文字を変更する必要が生じ、`proto/a1` と分離して `proto/a2` 用に独自のLexer定義を作成。
*   **Parser構造**:
    *   `structurize`（ブロック構築）ではなく `parseExpr`（式解析）フェーズで絶対値を処理することで、演算子の優先順位を正しく反映。

以上により、Sign言語の表現力が大幅に向上しました。
