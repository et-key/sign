# セルフホスト版の単独実行（スタンドアロン化）に向けて必要なこと

現在「JS版ツールを使ってJS上でSign製コードをパースする」状態から、完全にJSから脱却し、**「Sign言語自身がコンパイルした単一のバイナリ（WasmやAArch64等）」としてコマンドラインから単独実行できるようにする**ためには、以下の機能・実装の追加が必要です。

---

## 1. ファイルI/OとOSシステムコールの統合 (最重要)
現在のテスト環境は、ファイルの読み込みや標準出力（`console.log`相当）をJavaScriptホスト側に依存しています（`injectRuntime` や JSの `fs.readFileSync` など）。単独実行するためには、コンパイラ自身が「OSのAPI（System Calls / WASI）」を直接叩けるようにならなければなりません。

*   **入力ストリームの対応:** `$ node compiler.js test.sn` のように受け取った引数（ファイルパス）から、ファイルポインタを開いて文字列としてメモリに読み込むシステムコールの実装（またはWASI環境のセットアップ）。
*   **出力ストリームの対応:** 構文エラーの表示や、最終的なアセンブリ（`.s` や `.wasm`）を標準出力やファイルに書き出すためのバッファリングとシステムコール呼び出しの実装。

## 2. 動的メモリ管理周辺 (アロケータ)とガベージコレクション
JS環境では適当なメモリバッファリングやJS側のオブジェクト収集機能に助けられていますが、Signで作られたコンパイラ自身が「膨大な構文木（AST）を作り、コンパイル完了後に破棄する」ことを繰り返す場合、本格的なメモリ管理が必要です。
現在のa8のような「単調増加するアロケータ（`alloc` でポインタを進めるだけ）」だと、コンパイルするソースコードが大きいとすぐにメモリが枯渇します。（a7で `memory_management.md` などの検討が必要だったのはこのためです）。

*   （もし一時的な実行であれば）ヒープサイズの上限を大きく確保する起動プログラム。
*   長期的には不要なASTノードを解放する最低限のGC機構（マーク＆スイープ等）やデアロケータ。

## 3. バイナリ・エミッタ（直出力機能）の実装
現在、JS版コンパイラは「人間が読めるアセンブリテキスト（`.s`）」を文字列（String）として出力しています。もし高速で完全に単独なツールチェイン（`gcc` のようなもの）を目指すのであれば、文字列のテキスト出力だけでなく、**直接Wasmのバイナリフォーマット（`.wasm`）をバイト列として構築して吐き出す**（Binary Emitter）機能がSign側コンパイラ内に必要です。
テキスト出力のままだと、最終的なバイナリ生成のために別のアセンブラツール（LLVMやWasm/Watのコンパイラ等）が追加で必要になってしまいます。

## 4. エントリポイント（ブートストラップ）の構築
JavaScriptの `node parser.js` なしに直接バイナリとして起動するためには、OS連携の起点となるネイティブなメイン関数（Wasmの `_start` 等）が必要です。Signにおいて `main` 関数というものは単なる慣習でしかなく、**「`main.sn` などのファイル全体が一つの関数（エントリポイント）として評価される」**という哲学があります。

さらに、C言語等で一般的な `main(argc, argv)` のような引数の受けとり方も、Signでは特別な関数シグネチャとしては定義されません。起動時のコマンドライン引数や環境変数は、純粋な計算世界から分離された「IOによる副作用の文脈（`system_semantics_ja-jp.md` 等で規定されるIOモナド等）」を通じて取得されるべきパラメータとしてデザインされます。
したがって、ネイティブな起動関数から直接「対象ファイルの中身全体のパース・実行パイプライン」へと処理を渡しつつ、必要に応じてプログラムの先頭でIOコンテキストから引数を引き出す（副作用として扱う）小さなシェル（C言語やWasmで構築されたランタイムラッパー）が必要となります。
---

### まとめ（今後のロードマップ的な視点）

これらが揃えば、
```bash
# 最終的な目標
$ signc main.sn > main.wasm
```
というような、完全にスッキリした自分自身をコンパイルできるコマンドになります。
現在はその「頭脳（文字列をパースしてロジックを解析する部分）」を、手足（JS）を使って構築・テストしている段階です。手足（I/Oやメモリ管理）が揃えば、完全に独り立ちできます。
