
'use strict';

const prepare = code => code
  .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F\xA0\xAD]/g, '')
  .replace(/^\t*`[^\r]*`?$/gm, '')
  .replace(
    /(?<!\\)\\(\r\n|[\r\n])|(\r\n|[\r\n])/g,
    (_, $1, $2) => {
      switch (true) {
        case !!$1:
          return '\n';

        case !!$2:
          return '\r';

        default:
          return _;
      }
    }
  )
  .replace(
    /(`[^`\r\n]*`)|(?<!\\)([\{\(])|(?<!\\)([\}\)])/g,
    (_, $1, $2, $3 ) => $1  || ($2 && '[') || ($3 && ']')
  )

const procBinary = code => [
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\&\&) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\;\;) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\|\|) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\>\>) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\<\<) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\@) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\') +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\^) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\%) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\/) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\*) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\-) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\+) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\!\=) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\>) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\>\=) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\=\=) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\=) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\<\=) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\<) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\&) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\;) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\|) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\~\^) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\~\/) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\~\*) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\~\-) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\~\+) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\~) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\?) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\,) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\#) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g,
  /((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+) +(\:) +((`[^`\r\n]`)|(\\[\s\S]))|([^\r\t]+)/g
]
  .reduce(
    ( code, op ) => code
    // String.match を入れる必要がある（Maximum call stack size exceeded 対策） 
    .replace(
      op,
      (_, ...$) => `\x1D[\x1F${ !!$[3] ? procBinary( $[3] ) : $[0] }\x1F${ $[4] }\x1F${ !!$[8] ? procBinary( $[8] ) : $[5] }\x1F]\x1D`
    ),
     code
  );

const procUnary = code => code
  .replace(
    /(`[^\r\n`]*`)|(\\[\s\S])|([#~!$@])?([^\r\t ]+)([!~@])?/g,
    (_, ...$) => {
      switch (true) {
        case !!$[0]:
          return $[0];

        case !!$[1]:
          return $[1];
        
        default:
          return `\x1D[\x1F${$[2] ? `${$[2]}_` : ''}\x1F${ procUnary( $[3] ) }\x1F_${ $[4] ? `_${$[4]}` : '' }\x1F]\x1D`;
      }
    }
  );

const procBlock = code => code
  .replace(
    /(`[^\r\n`]*`)|(\\[\s\S])|(?<!\\)\r(?<!\\)\t([^\r]+)/g,
    (_, $1, $2, $3) => ($1 || $2) || `\r\x1D${ procBlock($3) }\x1D`
  )
  .replace(/(`[^\r`]*`)|(\\[\s\S])|\t/g, '$1$2');

const markSeparator = code => code
  .replace(
    /(`[^`\r\n]*`)|(\\[\s\S])|(?<!\\)(\[)|(?<!\\)(\])/g,
    (_, $1, $2, $3, $4) => ($1 || $2) || ($3 && '\x1D[\x1F') || ($4 && '\x1F]\x1D')
  );

const clean = tokens => tokens
  .map( t => Array.isArray(t) ? clean(t) : t )
  .filter( t => t.length > 0);

module.exports = code => markSeparator( procBlock( procBinary( procUnary( prepare(code) ) ) ) )
