# proto\wa1 演算子実装カバレッジ分析

## 概要
このドキュメントは、[A_Operator_Table.md](file:///c:/Users/ym_st/work_vscode/sign/documents/ja-jp/specification/A_Operator_Table.md) に定義されている演算子のうち、`proto\wa1` でどこまで実装されているかを精査した結果をまとめたものです。

---

## 実装状況サマリー

### 完全実装済み: 27演算子
### 部分実装済み: 3演算子  
### 未実装: 35演算子

**実装率: 約41% (27/65演算子)**

> [!NOTE]
> **最終更新**: 2026-02-03  
> 優先度「高」および「中」の演算子 (`~`, `!`, `'`, `@`) の実装が完了しました。

---

## 詳細分析

### ✅ 完全実装済み演算子

以下の演算子は、パーサーとコンパイラの両方で完全に実装されています。

| 優先順位 | 記号 | 位置 | 機能 | 実装箇所 |
|---------|------|------|------|---------|
| 2 | `:` | 中置 | define | Parser: 構造分割、Compiler: 条件分岐として実装 |
| 14 | `<` | 中置 | less | Compiler: `F64_LT` (line 498) |
| 14 | `<=` | 中置 | less_equal | Compiler: `F64_LE` (line 500) |
| 14 | `=` | 中置 | equal | Compiler: `F64_EQ` (line 496) |
| 14 | `>=` | 中置 | more_equal | Compiler: `F64_GE` (line 501) |
| 14 | `>` | 中置 | more | Compiler: `F64_GT` (line 499) |
| 14 | `!=` | 中置 | not_equal | Compiler: `F64_NE` (line 497) |
| 15 | `+` | 中置 | add | Compiler: `F64_ADD` (line 635) |
| 15 | `-` | 中置 | sub | Compiler: `F64_SUB` (line 637), 単項マイナスも実装 (line 604-609) |
| 16 | `*` | 中置 | mul | Compiler: `F64_MUL` (line 636) |
| 16 | `/` | 中置 | div | Compiler: `F64_DIV` (line 638) |
| 16 | `%` | 中置 | mod | Compiler: 剰余演算実装 (line 613-629) |
| 13 | `!` | 前置 | not | Compiler: `!_` として実装 (line 522-548) |
| 5 | ` ` | 中置 | apply | Compiler: 関数適用として実装 (line 582-594) |
| 6 | `?` | 中置 | lambda | Parser: ラムダ構文解析、Compiler: 関数定義 (line 358-367) |
| 11 | `|` | 中置 | or | Compiler: 短絡評価実装 (line 697-773) |
| 12 | `&` | 中置 | and | Compiler: 短絡評価実装 (line 776-798) |
| 11 | `;` | 中置 | xor | Compiler: 論理XOR実装 (line 801-841) |
| 17 | `^` | 中置 | pow | Compiler: `Math.pow` インポート経由で実装 (line 676-684) |
| 19 | `|...|` | 囲み | abs | Compiler: `F64_ABS` として実装 (line 866-870) |
| 9 | `~` | 中置 | range | Compiler: `range` ランタイム関数呼び出し (line 972-981) |
| 18 | `!` | 後置 | factorial | Compiler: `factorial` ランタイム関数呼び出し (line 985-992) |
| 22 | `'` | 中置 | get | Compiler: `nth` ランタイム関数呼び出し (line 996-1006) |
| 22 | `@` | 中置 | get | Compiler: `nth` ランタイム関数呼び出し (line 996-1006) |

---

### 🟡 部分実装済み演算子

以下の演算子は、パーサーでは認識されますが、コンパイラでの実装が不完全または未実装です。

| 優先順位 | 記号 | 位置 | 機能 | 実装状況 |
|---------|------|------|------|---------|
| 10 | `~` | 前置 | continuous | Parser: `~_` として認識、Compiler: 未実装 |
| 20 | `~` | 後置 | expand | Parser: `_~` として認識、Compiler: 未実装 |

---

### ❌ 未実装演算子

以下の演算子は、パーサーまたはコンパイラのいずれでも実装されていません。

#### 範囲演算子系 (優先順位 9)
| 記号 | 機能 | 状態 |
|------|------|------|
| `~+` | 等差数列指定 | Parser: operators.js に定義、Compiler: 未実装 |
| `~-` | 等差逆数列指定 | Parser: operators.js に定義、Compiler: 未実装 |
| `~*` | 等比数列指定 | Parser: operators.js に定義、Compiler: 未実装 |
| `~/` | 等比逆数列指定 | Parser: operators.js に定義、Compiler: 未実装 |
| `~^` | 等冪数列指定 | Parser: operators.js に定義、Compiler: 未実装 |

#### アドレス演算子 (優先順位 21)

| 優先順位 | 記号 | 位置 | 機能 | 状態 |
|---------|------|------|------|------|
| 21 | `$` | 前置 | address | Parser: operators.js に定義、Compiler: 未実装 |

#### ビット演算子系 (優先順位 24-29)
| 22 | `'` | 中置 | get | Parser: operators.js に定義、Compiler: 未実装 |
| 22 | `@` | 中置 | get | Parser: overrides に定義、Compiler: 未実装 |
| 23 | `@` | 前置 | input | Parser: `@_` として認識、Compiler: 未実装 |
| 29 | `@` | 後置 | import | Parser: `_@` として認識、Compiler: 未実装 |

#### ビット演算子系
| 優先順位 | 記号 | 機能 | 状態 |
|---------|------|------|------|
| 24 | `<<` | 左ビットシフト | Parser: operators.js に定義、Compiler: 未実装 |
| 24 | `>>` | 右ビットシフト | Parser: operators.js に定義、Compiler: 未実装 |
| 25 | `\|\|` | bit or | Parser: operators.js に定義、Compiler: 未実装 |
| 26 | `;;` | bit xor | Parser: operators.js に定義、Compiler: 未実装 |
| 27 | `&&` | bit and | Parser: operators.js に定義、Compiler: 未実装 |
| 28 | `!!` | bit not | Parser: `!!_` として定義、Compiler: 未実装 |

#### ブロック構文
| 優先順位 | 記号 | 位置 | 機能 | 状態 |
|---------|------|------|------|------|
| 30 | `(...)` | 囲み | block | Parser: 未実装 |
| 30 | `{...}` | 囲み | block | Parser: 未実装 |
| 30 | `[...]` | 囲み | block | Parser: ブラケット構造として実装、Compiler: ブロックとしては未実装 |
| 30 | `\t` | 前置 | indent | Parser: インデントブロックとして実装、Compiler: 未実装 |

#### 特殊記号
| 記号 | 機能 | 状態 |
|------|------|------|
| `_` | unit | Compiler: `NaN` として実装 (line 417-419) |
| `==` | equal | Parser: operators.js に定義、Compiler: `=` と同じ扱い可能だが明示的実装なし |

---

## 実装の詳細

### パーサー実装 ([parser.js](file:///c:/Users/ym_st/work_vscode/sign/proto/wa1/parser.js))

パーサーは以下の演算子を認識します:

1. **operators.js からインポート**: 大部分の演算子定義
2. **overrides オブジェクト** (line 226-237): 文脈依存の演算子
   - `!`: 前置 (`!_`) / 後置 (`_!`)
   - `~`: 前置 (`~_`) / 中置 (`~`) / 後置 (`_~`)
   - `#`: 前置 (`#_`) / 中置 (`#`)
   - `@`: 前置 (`@_`) / 中置 (`@`) / 後置 (`_@`)
   - `|`: 前置 (`[|`) / 中置 (`|`) / 後置 (`|]`)

3. **特殊処理**:
   - 空白演算子 (` `): 関数適用として処理
   - 改行: `,` 演算子に変換
   - `?`: ラムダ構文の構造分割

### コンパイラ実装 ([compiler.js](file:///c:/Users/ym_st/work_vscode/sign/proto/wa1/compiler.js))

コンパイラの `compileExpr` メソッド (line 415-645) で以下を処理:

1. **比較演算子** (line 479-519): `<`, `>`, `<=`, `>=`, `=`, `!=`
   - WebAssembly の `F64_EQ`, `F64_NE`, `F64_LT`, `F64_GT`, `F64_LE`, `F64_GE` を使用
   - 真の場合は RHS を返し、偽の場合は `NaN` を返す (チェーン比較対応)

2. **論理否定** (line 522-548): `!_`
   - Truthy → `NaN` (False)
   - Falsy → `0.0` (True)

3. **条件分岐** (line 552-578): `:`
   - 条件が Truthy なら then 式を評価、Falsy なら `NaN` を返す

4. **関数呼び出し** (line 582-594): ` ` (空白)
   - `flattenCall` で引数を展開し、`CALL` 命令を生成

5. **算術演算子** (line 598-639): `+`, `-`, `*`, `/`, `%`
   - WebAssembly の `F64_ADD`, `F64_SUB`, `F64_MUL`, `F64_DIV` を使用
   - 単項マイナス: `0 - val` として実装
   - 剰余: `a - b * trunc(a/b)` として実装

6. **ランタイム関数** (line 170-274):
   - `alloc`: ヒープメモリ割り当て
   - `cons`: リスト構築 (head, tail)
   - `head`: リストの先頭取得
   - `tail`: リストの末尾取得

---

## 推奨される次のステップ

### ✅ 優先度 高 (完了)
1. ~~**論理演算子の実装**: `&` (and), `|` (or), `;` (xor)~~ ✅ 完了
   - 短絡評価を実装済み
2. ~~**指数演算子**: `^` (pow)~~ ✅ 完了
   - `Math.pow` を Wasm Import 経由で実装済み
3. ~~**絶対値演算子**: `|...|`~~ ✅ 完了
   - `F64_ABS` 命令として実装済み

### ✅ 優先度 中 (完了)
4. ~~**範囲演算子**: `~`~~ ✅ 完了
   - `range` ランタイム関数として実装
5. ~~**アクセス演算子**: `'`, `@` (中置)~~ ✅ 完了
   - `nth` ランタイム関数として実装
6. ~~**階乗演算子**: `!` (後置)~~ ✅ 完了
   - `factorial` ランタイム関数として実装

### 優先度 低 (プロトタイプでは除外)
7. **拡張範囲演算子**: `~+`, `~-`, `~*`, `~/`, `~^`
   - 基本 `~` は実装済みだが、ステップ指定系は未実装
8. **ビット演算子**: `<<`, `>>`, `||`, `;;`, `&&`, `!!`
   - WebAssembly の i32 ビット演算命令を使用
9. **エクスポート演算子**: `#`, `##`, `###`
   - モジュールシステムの実装が必要
10. **ブロック構文**: `(...)`, `{...}`
    - 現在はインデントとブラケットのみ対応

> [!NOTE]
> **プロトタイプスコープについて**
> 
> 優先度「高」および「中」の演算子は、Sign言語の核となる機能として実装が必要です。
> 優先度「低」の演算子（ビット演算、エクスポート、ブロック構文）は、プロトタイプ段階では除外し、将来的な拡張として扱います。

---

## 注意事項

> [!IMPORTANT]
> - 現在の実装は **f64 (浮動小数点数) のみ** をサポートしています
> - 整数演算が必要な演算子 (ビット演算など) は i32 型のサポートが必要です
> - リスト構築は `cons` 関数として実装されていますが、`,` 演算子との統合は未完了です
> - **Truthiness**: `_` (NaN) のみが False。`0` を含む他の全ての値は True として扱われます

> [!WARNING]
> - `:` 演算子は仕様では「定義」ですが、コンパイラでは「条件分岐」として実装されています

---

## 結論

`proto\wa1` は、基本的な算術演算、比較演算、**論理演算 (短絡評価対応)**、関数定義・呼び出しなど、**Sign言語の核となる機能**は実装されています。

**最近の進捗** (2026-02-03):
- 優先度「高」演算子 (`&`, `|`, `;`, `^`, `|x|`) 実装完了
- 優先度「中」演算子 (`~`, `!`, `'`, `@`) 実装完了
- 実装率が 31% → 41% に向上

**今後の課題**:
残るは「優先度：低」の演算子（ビット演算、ブロック、エクスポート）と、範囲演算子の拡張版（`~+` 等）です。
プロトタイプとしての主要機能要件はほぼ満たされました。
