# proto\wa1 演算子実装カバレッジ分析

## 概要
このドキュメントは、[A_Operator_Table.md](../../documents/ja-jp/specification/A_Operator_Table.md) に定義されている演算子のうち、`proto\wa1` でどこまで実装されているかを精査した結果をまとめたものです。

---

## 実装状況サマリー

### 完全実装済み: 34演算子
### 部分実装済み: 2演算子  
### 未実装: 35演算子

**実装率: 約48% (34/71演算子)**

> [!NOTE]
> **最終更新**: 2026-02-05  
> 優先度「高」および「中」の演算子、ビット演算子の実装が完了しました。  
> A_Operator_Table.mdに定義されている全71演算子を網羅的に分析しました。

---

## 詳細分析

### ✅ 完全実装済み演算子

以下の演算子は、パーサーとコンパイラの両方で完全に実装されています。

| 優先順位 | 記号 | 位置 | 機能 | 実装箇所 |
|---------|------|------|------|---------|
| 2 | `:` | 中置 | define | Parser: 構造分割、Compiler: 条件分岐として実装 |
| 14 | `<` | 中置 | less | Compiler: `F64_LT` (line 498) |
| 14 | `<=` | 中置 | less_equal | Compiler: `F64_LE` (line 500) |
| 14 | `=` | 中置 | equal | Compiler: `F64_EQ` (line 496) |
| 14 | `>=` | 中置 | more_equal | Compiler: `F64_GE` (line 501) |
| 14 | `>` | 中置 | more | Compiler: `F64_GT` (line 499) |
| 14 | `!=` | 中置 | not_equal | Compiler: `F64_NE` (line 497) |
| 15 | `+` | 中置 | add | Compiler: `F64_ADD` (line 635) |
| 15 | `-` | 中置 | sub | Compiler: `F64_SUB` (line 637), 単項マイナスも実装 (line 604-609) |
| 16 | `*` | 中置 | mul | Compiler: `F64_MUL` (line 636) |
| 16 | `/` | 中置 | div | Compiler: `F64_DIV` (line 638) |
| 16 | `%` | 中置 | mod | Compiler: 剰余演算実装 (line 613-629) |
| 13 | `!` | 前置 | not | Compiler: `!_` として実装 (line 522-548) |
| 5 | ` ` | 中置 | apply | Compiler: 関数適用として実装 (line 582-594) |
| 6 | `?` | 中置 | lambda | Parser: ラムダ構文解析、Compiler: 関数定義 (line 358-367) |
| 11 | `|` | 中置 | or | Compiler: 短絡評価実装 (line 697-773) |
| 12 | `&` | 中置 | and | Compiler: 短絡評価実装 (line 776-798) |
| 11 | `;` | 中置 | xor | Compiler: 論理XOR実装 (line 801-841) |
| 17 | `^` | 中置 | pow | Compiler: `Math.pow` インポート経由で実装 (line 676-684) |
| 19 | `|...|` | 囲み | abs | Compiler: `F64_ABS` として実装 (line 866-870) |
| 9 | `~` | 中置 | range | Compiler: `range` ランタイム関数呼び出し (line 972-981) |
| 18 | `!` | 後置 | factorial | Compiler: `factorial` ランタイム関数呼び出し (line 985-992) |
| 22 | `'` | 中置 | get | Compiler: `nth` ランタイム関数呼び出し (line 996-1006) |
| 22 | `@` | 中置 | get | Compiler: `nth` ランタイム関数呼び出し (line 996-1006) |
| 24 | `<<` | 中置 | bit_left_shift | Compiler: i32変換後 `I32_SHL` (ビット演算として実装) |
| 24 | `>>` | 中置 | bit_right_shift | Compiler: i32変換後 `I32_SHR_S` (ビット演算として実装) |
| 25 | `\|\|` | 中置 | bit_or | Compiler: i32変換後 `I32_OR` (ビット演算として実装) |
| 26 | `;;` | 中置 | bit_xor | Compiler: i32変換後 `I32_XOR` (ビット演算として実装) |
| 27 | `&&` | 中置 | bit_and | Compiler: i32変換後 `I32_AND` (ビット演算として実装) |
| 28 | `!!` | 前置 | bit_not | Compiler: i32変換後 `I32_XOR` with -1 (ビット演算として実装) |

#### 特殊記号
| 記号 | 機能 | 実装箇所 |
|------|------|----------|
| `_` | unit | Compiler: `NaN` として実装 (line 559-561) |

---

### 🟡 部分実装済み演算子

以下の演算子は、パーサーでは認識されますが、コンパイラでの実装が不完全または未実装です。

| 優先順位 | 記号 | 位置 | 機能 | 実装状況 |
|---------|------|------|------|---------|
| 10 | `~` | 前置 | continuous | Parser: `~_` として認識、Compiler: 未実装 |
| 20 | `~` | 後置 | expand | Parser: `_~` として認識、Compiler: 未実装 |

> [!NOTE]
> 中置の `~` (range) は完全実装済みですが、前置・後置の `~` は未実装です。

---

### ❌ 未実装演算子

以下の演算子は、パーサーまたはコンパイラのいずれでも実装されていません。

#### エクスポート演算子 (優先順位 1, 3)
| 優先順位 | 記号 | 位置 | 機能 | 状態 |
|---------|------|------|------|------|
| 1 | `#` | 前置 | export | Parser: operators.js に定義、Compiler: 未実装 |
| 1 | `##` | 前置 | export | Parser: operators.js に定義、Compiler: 未実装 |
| 1 | `###` | 前置 | export | Parser: operators.js に定義、Compiler: 未実装 |
| 3 | `#` | 中置 | output | Parser: operators.js に定義、Compiler: 未実装 |

#### プロダクト演算子 (優先順位 4)
| 優先順位 | 記号 | 位置 | 機能 | 状態 |
|---------|------|------|------|------|
| 4 | `,` | 中置 | product | Parser: `,` として認識、Compiler: リスト構築としては未実装 |

> [!NOTE]
> `,` はパーサーで区切り文字として使われていますが、右結合なリスト構築演算子としてのコンパイラ実装はありません。

#### 範囲演算子系 (優先順位 9)
| 記号 | 機能 | 状態 |
|------|------|------|
| `~+` | 等差数列指定 | Parser: operators.js に定義、Compiler: 未実装 |
| `~-` | 等差逆数列指定 | Parser: operators.js に定義、Compiler: 未実装 |
| `~*` | 等比数列指定 | Parser: operators.js に定義、Compiler: 未実装 |
| `~/` | 等比逆数列指定 | Parser: operators.js に定義、Compiler: 未実装 |
| `~^` | 等冪数列指定 | Parser: operators.js に定義、Compiler: 未実装 |

#### アドレス演算子 (優先順位 21)

| 優先順位 | 記号 | 位置 | 機能 | 状態 |
|---------|------|------|------|------|
| 21 | `$` | 前置 | address | Parser: operators.js に定義、Compiler: 未実装 |

#### I/O・Import演算子

| 優先順位 | 記号 | 位置 | 機能 | 状態 |
|---------|------|------|------|------|
| 23 | `@` | 前置 | input | Parser: `@_` として認識、Compiler: 未実装 |
| 29 | `@` | 後置 | import | Parser: `_@` として認識、Compiler: 未実装 |

#### ブロック構文
| 優先順位 | 記号 | 位置 | 機能 | 状態 |
|---------|------|------|------|------|
| 30 | `(...)` | 囲み | block | Parser: 未実装 |
| 30 | `{...}` | 囲み | block | Parser: 未実装 |
| 30 | `[...]` | 囲み | block | Parser: ブラケット構造として実装、Compiler: ブロックとしては未実装 |
| 30 | `\t` | 前置 | indent | Parser: インデントブロックとして実装、Compiler: 未実装 |

#### 特殊記号
| 記号 | 機能 | 状態 |
|------|------|------|
| `==` | equal | Parser: operators.js に定義、Compiler: `=` と同等だが明示的実装なし |

> [!NOTE]
> `==` は `=` と同じ比較演算子として定義されていますが、コンパイラでは `=` のみ実装されています。

---

## 実装の詳細

### パーサー実装 ([parser.js](parser.js))

パーサーは以下の演算子を認識します:

1. **operators.js からインポート**: 大部分の演算子定義
2. **overrides オブジェクト** (line 226-237): 文脈依存の演算子
   - `!`: 前置 (`!_`) / 後置 (`_!`)
   - `~`: 前置 (`~_`) / 中置 (`~`) / 後置 (`_~`)
   - `#`: 前置 (`#_`) / 中置 (`#`)
   - `@`: 前置 (`@_`) / 中置 (`@`) / 後置 (`_@`)
   - `|`: 前置 (`[|`) / 中置 (`|`) / 後置 (`|]`)

3. **特殊処理**:
   - 空白演算子 (` `): 関数適用として処理
   - 改行: `,` 演算子に変換
   - `?`: ラムダ構文の構造分割

### コンパイラ実装 ([compiler.js](compiler.js))

コンパイラの `compileExpr` メソッド (line 557-1078) で以下を処理:

1. **比較演算子** (line 622-661): `<`, `>`, `<=`, `>=`, `=`, `!=`
   - WebAssembly の `F64_EQ`, `F64_NE`, `F64_LT`, `F64_GT`, `F64_LE`, `F64_GE` を使用
   - 真の場合は RHS を返し、偽の場合は `NaN` を返す (チェーン比較対応)

2. **論理否定** (line 664-691): `!_`
   - Truthy → `NaN` (False)
   - Falsy → `0.0` (True)

3. **条件分岐** (line 694-721): `:`
   - 条件が Truthy なら then 式を評価、Falsy なら `NaN` を返す

4. **関数呼び出し** (line 724-737): ` ` (空白)
   - `flattenCall` で引数を展開し、`CALL` 命令を生成

5. **算術演算子** (line 740-793): `+`, `-`, `*`, `/`, `%`, `^`
   - WebAssembly の `F64_ADD`, `F64_SUB`, `F64_MUL`, `F64_DIV` を使用
   - 単項マイナス: `0 - val` として実装 (line 746-752)
   - 剰余: `a - b * trunc(a/b)` として実装 (line 755-772)
   - 指数: `Math.pow` を Import 経由で呼び出し (line 782-790)

6. **論理演算子** (line 796-978): `&`, `|`, `;`
   - `|` (OR): 短絡評価、左が Truthy なら左を返し、Falsy なら右を返す (line 805-880)
   - `&` (AND): 短絡評価、左が Truthy なら右を返し、Falsy なら左を返す (line 884-905)
   - `;` (XOR): 両辺を評価し、Truthy が1つだけなら Truthy 値を返し、それ以外は `NaN` (line 909-977)

7. **ビット演算子** (line 981-1012): `<<`, `>>`, `||`, `;;`, `&&`, `!!`
   - F64 → I32 変換後 WebAssembly の `I32_SHL`, `I32_SHR_S`, `I32_OR`, `I32_XOR`, `I32_AND` を使用
   - 結果を F64 に再変換
   - `!!` (bit not): `I32_XOR` with -1 として実装 (line 1003-1012)

8. **絶対値演算子** (line 1036-1041): `|...|` (Parser では `!-` として表現)
   - WebAssembly の `F64_ABS` 命令を使用

9. **範囲演算子** (line 1044-1052): `~` (中置)
   - `range` ランタイム関数を呼び出し

10. **階乗演算子** (line 1056-1062): `!` (後置、Parser では `_!` として表現)
    - `factorial` ランタイム関数を呼び出し

11. **アクセス演算子** (line 1065-1073): `'`, `@` (中置)
    - `nth` ランタイム関数を呼び出し

12. **ランタイム関数** (line 185-388):
    - `alloc`: ヒープメモリ割り当て (line 190-218)
    - `cons`: リスト構築 (head, tail) (line 220-256)
    - `head`: リストの先頭取得 (line 258-275)
    - `tail`: リストの末尾取得 (line 277-291)
    - `range`: 等差数列生成 (再帰的実装) (line 293-325)
    - `factorial`: 階乗計算 (再帰的実装) (line 327-354)
    - `nth`: リスト要素アクセス (再帰的実装) (line 356-386)

---

## 推奨される次のステップ

### ✅ 優先度 高 (完了)
1. ~~**論理演算子の実装**: `&` (and), `|` (or), `;` (xor)~~ ✅ 完了
   - 短絡評価を実装済み (`&`, `|` のみ。`;` は両辺を必ず評価)
2. ~~**指数演算子**: `^` (pow)~~ ✅ 完了
   - `Math.pow` を Wasm Import 経由で実装済み
3. ~~**絶対値演算子**: `|...|`~~ ✅ 完了
   - `F64_ABS` 命令として実装済み

### ✅ 優先度 中 (完了)
4. ~~**範囲演算子**: `~` (中置)~~ ✅ 完了
   - `range` ランタイム関数として実装
5. ~~**アクセス演算子**: `'`, `@` (中置)~~ ✅ 完了
   - `nth` ランタイム関数として実装
6. ~~**階乗演算子**: `!` (後置)~~ ✅ 完了
   - `factorial` ランタイム関数として実装
7. ~~**ビット演算子**: `<<`, `>>`, `||`, `;;`, `&&`, `!!`~~ ✅ 完了
   - WebAssembly の i32 ビット演算命令を使用して実装済み

### 優先度 低 (プロトタイプでは除外または実装不要)
8. **拡張範囲演算子**: `~+`, `~-`, `~*`, `~/`, `~^`
   - 基本 `~` は実装済みだが、ステップ指定系は未実装
9. **エクスポート演算子**: `#`, `##`, `###`
   - モジュールシステムの実装が必要
10. **ブロック構文**: `(...)`, `{...}`
    - **実装不要**: Parser側でインデント (`\t`) と `[...]` でブロック構造をJSON化済み
    - `(...)` と `{...}` の明示的実装は、現状のインデント・ブラケット構文で十分表現可能

> [!NOTE]
> **プロトタイプスコープについて**
> 
> 優先度「高」および「中」の演算子は、Sign言語の核となる機能として実装が必要です。
> 優先度「低」の演算子（ビット演算、エクスポート、ブロック構文）は、プロトタイプ段階では除外し、将来的な拡張として扱います。

---

## 注意事項

> [!IMPORTANT]
> - 現在の実装は **f64 (浮動小数点数) のみ** をサポートしています
> - 整数演算が必要な演算子 (ビット演算など) は i32 型のサポートが必要です
> - リスト構築は `cons` 関数として実装されていますが、`,` 演算子との統合は未完了です
> - **Truthiness**: `_` (NaN) のみが False。`0` を含む他の全ての値は True として扱われます

> [!WARNING]
> - `:` 演算子は仕様では「定義」ですが、コンパイラでは「条件分岐」として実装されています

---

## 結論

`proto\wa1` は、基本的な算術演算、比較演算、**論理演算 (短絡評価対応)**、関数定義・呼び出しなど、**Sign言語の核となる機能**は実装されています。

**最近の進捗** (2026-02-05):
- 優先度「高」演算子 (`&`, `|`, `;`, `^`, `|x|`) 実装完了
- 優先度「中」演算子 (`~`, `!`, `'`, `@`) 実装完了
- ビット演算子 (`<<`, `>>`, `||`, `;;`, `&&`, `!!`) 実装完了
- **全71演算子の網羅的分析完了**: A_Operator_Table.mdに定義されている全演算子を調査
- 実装率: **48%** (34/71演算子)

**今後の課題**:
残るは以下の演算子です：
- エクスポート演算子: `#`, `##`, `###`
- プロダクト演算子: `,` (右結合リスト構築)
- 範囲演算子の拡張版: `~+`, `~-`, `~*`, `~/`, `~^`
- I/O・Import演算子: `@_` (input), `_@` (import)
- その他低優先度演算子

プロトタイプとしての主要機能要件（算術・比較・論理・ビット演算、関数定義・呼び出し）は完全に実装されました。

